<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifly | Ultimate Campus System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --primary: #6C5CE7; --bg-body: #f5f7fa; --bg-card: #ffffff; --text-main: #2d3436; --text-sub: #636e72; --border: #dfe6e9; }
        body.dark-mode { --primary: #a29bfe; --bg-body: #1e1e1e; --bg-card: #2d2d2d; --text-main: #dfe6e9; --text-sub: #b2bec3; --border: #444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; transition: background 0.3s, color 0.3s; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-primary:disabled { background: #b2bec3; cursor: not-allowed; transform: none; }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text-main); }
        .btn-danger { background: #ff7675; color: white; }
        .btn-success { background: #00b894; color: white; }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; }
        .btn-xs { padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; }
        .btn-key { background: #dfe6e9; color: #2d3436; margin-right: 5px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        
        /* Landing */
        .landing-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: white; text-align: center; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .role-cards { display: flex; gap: 30px; margin-top: 40px; }
        .role-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; text-align: center; width: 220px; }
        .role-card:hover { background: rgba(255,255,255,0.2); transform: translateY(-10px); }

        /* Navbar */
        .app-view { padding: 20px; max-width: 1200px; margin: 0 auto; display: none; }
        .navbar { background: var(--bg-card); padding: 15px 25px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; margin-left: 15px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Notifications */
        .notif-wrapper { position: relative; margin-right: 10px; }
        .btn-bell { background: #dfe6e9; color: #2d3436; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: none; }
        .notif-badge { position: absolute; top: -2px; right: -2px; background: #ff7675; color: white; font-size: 0.7rem; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-card); }
        .notif-dropdown { position: absolute; top: 50px; right: -10px; width: 320px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; overflow: hidden; display: none; }
        .notif-dropdown.show { display: block; animation: slideDown 0.2s ease-out; }
        .notif-header { padding: 12px 15px; border-bottom: 1px solid var(--border); font-weight: bold; font-size: 0.9rem; background: var(--bg-body); display:flex; justify-content:space-between; align-items:center; }
        .notif-list { max-height: 300px; overflow-y: auto; }
        .notif-item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; position: relative; }
        .notif-item:hover { background: rgba(108, 92, 231, 0.05); }
        .notif-item.unread { border-left: 4px solid var(--primary); background: rgba(108, 92, 231, 0.03); }
        .notif-text { font-size: 0.85rem; margin-bottom: 4px; line-height: 1.4; }
        .notif-time { font-size: 0.7rem; color: var(--text-sub); }

        /* Forms & Cards */
        .card { background: var(--bg-card); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); }
        .checkbox-section { margin-bottom: 15px; }
        .checkbox-label { font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 5px; color: var(--primary); }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); }
        .checkbox-item { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.85rem; width: 140px; }

        /* RICH TEXT & CALENDAR Styles */
        #editor-container { height: 150px; background: var(--bg-body); color: var(--text-main); border-radius: 8px; }
        .ql-toolbar { background: var(--bg-body); border-radius: 8px 8px 0 0; border-color: var(--border) !important; }
        .ql-container { border-radius: 0 0 8px 8px; border-color: var(--border) !important; font-family: 'Outfit', sans-serif !important; }
        #calendarView { background: var(--bg-card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .fc-toolbar-title { font-size: 1.2rem !important; }
        .fc-button-primary { background-color: var(--primary) !important; border-color: var(--primary) !important; }

        /* Notice Card */
        .notice-card { background: var(--bg-card); border-radius: 15px; padding: 20px; margin-bottom: 20px; position: relative; border-left: 5px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .notice-card.hidden-event { opacity: 0.6; border-left-color: #999; border-style: dashed; }
        .notice-card:hover { transform: translateY(-3px); }
        .pinned-badge { background: #d63031; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; display: inline-block; }
        .tag-container { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; align-items: center; }
        .category-tag { font-size: 0.7rem; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .dept-tag { font-size: 0.75rem; font-weight: bold; color: var(--primary); text-transform: uppercase; background: rgba(108, 92, 231, 0.1); padding: 2px 6px; border-radius: 4px;}
        .year-tag { font-size: 0.75rem; font-weight: bold; color: #00b894; text-transform: uppercase; background: rgba(0, 184, 148, 0.1); padding: 2px 6px; border-radius: 4px;}
        .event-title-link { color: var(--primary); text-decoration: none; cursor: pointer; font-size: 1.3rem; font-weight: 700; display: block; margin-top: 5px; }
        .event-title-link:hover { text-decoration: underline; }
        .date-badge { font-size: 0.85rem; color: var(--text-sub); display: flex; align-items: center; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .registered-count { background: #ffeaa7; color: #d35400; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-left: auto; }

        /* Search & Tabs */
        .controls-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 2; position: relative; }
        .search-box input { margin: 0; padding-left: 40px; border-radius: 50px; border: 1px solid var(--border); }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        .tab-group { display: flex; background: var(--border); padding: 5px; border-radius: 50px; }
        .tab-btn { padding: 8px 20px; border: none; background: transparent; cursor: pointer; border-radius: 40px; font-weight: 600; color: var(--text-sub); transition: 0.3s; }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Modals & Profile */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: 15px; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto; animation: popIn 0.3s; }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .detail-img { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 20px; background: #eee; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; display: block; border: 3px solid var(--primary); }
        .file-upload-box { border: 2px dashed var(--border); padding: 15px; border-radius: 8px; text-align: center; margin: 10px 0; background: var(--bg-body); }
        .file-preview { max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 5px; display: none; margin-left: auto; margin-right: auto; }
        
        /* Comments */
        .qa-section { border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px; }
        .qa-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .comment-list { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; padding-right: 5px; }
        .comment-card { background: var(--bg-body); padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; position: relative; }
        .comment-card.admin-comment { border-left: 4px solid var(--primary); background: rgba(108, 92, 231, 0.05); }
        .comment-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 5px; align-items: center;}
        .badge-admin { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; margin-left: 8px; }
        .action-icon { cursor: pointer; color: #b2bec3; transition: 0.2s; margin-left: 8px; }
        .action-icon:hover { color: var(--primary); }
        .delete-icon:hover { color: #ff7675; }
        .comment-input-area { display: flex; gap: 10px; align-items: center; }
        .comment-input-area input { margin: 0; flex: 1; }
        .comment-edit-form { display: flex; gap: 5px; margin-top: 5px; }
        .comment-edit-form input { margin: 0; flex: 1; padding: 5px; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div id="landingPage" class="landing-container">
        <h1 style="font-size: 3.5rem;">Notifly</h1>
        <p style="font-size: 1.2rem; margin-bottom: 30px;">Never Miss an Opportunity Again</p>
        <div class="role-cards">
            <div class="role-card" onclick="openLogin('admin')"><i class="fas fa-user-shield" style="font-size: 2rem; margin-bottom: 10px;"></i><h3>Staff Login</h3><p>Principal & HODs</p></div>
            <div class="role-card" onclick="openLogin('student')"><i class="fas fa-user-graduate" style="font-size: 2rem; margin-bottom: 10px;"></i><h3>Student Login</h3><p>Secure ID Access</p></div>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay hidden"><div class="modal-box" style="width: 400px;"><h2 id="loginTitle" style="text-align: center; margin-bottom: 20px;">Login</h2><form onsubmit="handleLogin(event)"><label>User ID</label><input type="text" id="userId" placeholder="Enter ID..." required><label>Password</label><input type="password" id="password" required><button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Login</button><button type="button" class="btn btn-outline" style="width: 100%; margin-top: 5px;" onclick="closeLogin()">Cancel</button></form></div></div>
    <div id="passwordModal" class="modal-overlay hidden"><div class="modal-box" style="width: 400px;"><h2 style="text-align: center; margin-bottom: 20px;">Change Password</h2><form onsubmit="handleChangePassword(event)"><label>Current Password</label><input type="password" id="oldPass" required><label>New Password</label><input type="password" id="newPass" required><button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Update Password</button><button type="button" class="btn btn-outline" style="width: 100%; margin-top: 5px;" onclick="document.getElementById('passwordModal').classList.add('hidden')">Cancel</button></form></div></div>
    <div id="profileModal" class="modal-overlay hidden"><div class="modal-box" style="width: 400px;"><h2 style="text-align: center; margin-bottom: 20px;">My Profile</h2><form onsubmit="handleSaveProfile(event)"><img id="profileAvatar" class="profile-avatar" src="" alt="Profile"><div class="file-upload-box" style="padding: 10px;"><label style="cursor: pointer; display: block; font-size: 0.85rem;"><i class="fas fa-camera" style="color: var(--primary);"></i> Change Photo<input type="file" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(this)"></label><input type="hidden" id="profileBase64"></div><label>User ID (Read Only)</label><input type="text" id="profileId" disabled style="opacity: 0.7;"><label>Phone Number</label><input type="tel" id="profilePhone" placeholder="+91 99999 99999"><button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">Save Changes</button><button type="button" class="btn btn-outline" style="width: 100%; margin-top: 5px;" onclick="document.getElementById('profileModal').classList.add('hidden')">Close</button></form></div></div>

    <div id="eventDetailModal" class="modal-overlay hidden">
        <div class="modal-box">
            <img id="detailImg" class="detail-img hidden" src="" alt="Event Image">
            <div id="detailPdfSection" class="hidden" style="margin-bottom: 20px; text-align: center; padding: 20px; background: #eee; border-radius: 10px;"><i class="fas fa-file-pdf" style="font-size: 3rem; color: #d63031; margin-bottom: 10px;"></i><br><a id="detailPdfLink" href="#" download="notice.pdf" class="btn btn-primary btn-sm"><i class="fas fa-download"></i> Download Official Circular (PDF)</a></div>
            <h2 id="detailTitle" style="margin-bottom: 10px;">Event Title</h2>
            <div class="tag-container" id="detailTags" style="margin-bottom: 15px;"></div>
            <div id="detailDesc" style="color: var(--text-sub); line-height: 1.6; margin-bottom: 20px;"></div>
            <div style="background: var(--bg-body); padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p><strong><i class="far fa-calendar-alt"></i> Date:</strong> <span id="detailDates"></span></p></div>
            <button id="adminExportBtn" class="btn btn-success hidden" style="width: 100%; margin-bottom: 10px;" onclick="downloadParticipantsCSV()"><i class="fas fa-file-csv"></i> Download Student List (CSV)</button>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;"><a id="detailRegLink" href="#" target="_blank" class="btn btn-primary" style="flex: 1; text-align: center; text-decoration: none;"><i class="fas fa-external-link-alt"></i> External Register</a><button id="internalRegBtn" class="btn btn-outline" style="flex: 1;" onclick=""><i class="fas fa-check-circle"></i> Register Interest</button></div>
            <button id="addToCalBtn" class="btn btn-google" onclick=""><i class="far fa-calendar-plus"></i> Set Reminder (Google Calendar)</button>
            <div class="qa-section"><div class="qa-title"><i class="fas fa-comments" style="color: var(--primary);"></i> Queries & Feedback</div><div id="commentList" class="comment-list"></div><form class="comment-input-area" onsubmit="handlePostComment(event)"><input type="text" id="commentInput" placeholder="Ask a doubt or give feedback..." required><button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-paper-plane"></i></button></form></div>
            <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" onclick="closeDetailModal()">Close</button>
        </div>
    </div>

    <div id="mainDashboard" class="app-view">
        <nav class="navbar">
            <div style="display: flex; align-items: center; gap: 10px;"><i class="fas fa-layer-group" style="color: var(--primary);"></i><h3 id="welcomeMsg">Welcome</h3></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="notif-wrapper"><button class="btn-bell" onclick="toggleNotifications()"><i class="fas fa-bell"></i><span id="notifBadge" class="notif-badge hidden">0</span></button><div id="notifDropdown" class="notif-dropdown"><div class="notif-header">Notifications <button onclick="clearAllNotifications()" class="btn-xs btn-outline">Clear</button></div><div id="notifList" class="notif-list"></div></div></div>
                <div style="display: flex; align-items: center;"><i class="fas fa-moon"></i><label class="toggle-switch"><input type="checkbox" onchange="toggleDarkMode()"><span class="slider"></span></label></div>
                <button onclick="openProfileModal()" class="btn btn-key" title="My Profile"><i class="fas fa-user-circle"></i></button>
                <button onclick="openPasswordModal()" class="btn btn-key" title="Change Password"><i class="fas fa-key"></i></button>
                <button onclick="logout()" class="btn btn-danger">Logout</button>
            </div>
        </nav>

        <div id="adminPanel" class="card hidden">
            <h3><i class="fas fa-plus-circle"></i> Post New Event</h3>
            <form id="noticeForm">
                <input type="hidden" id="editId"><input type="hidden" id="uploadedBase64">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="checkbox-section"><span class="checkbox-label">1. Target Departments:</span><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" id="dept-all" value="All" onchange="toggleCheckboxes('dept')"> üåç All</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="CSE"> CSE</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="ECE"> ECE</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="EEE"> EEE</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="IT"> IT</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="MECH"> MECH</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="CIVIL"> CIVIL</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="AIML"> AIML</label><label class="checkbox-item"><input type="checkbox" class="dept-chk" value="AIDS"> AIDS</label></div></div>
                    <div class="checkbox-section"><span class="checkbox-label">2. Target Year:</span><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" id="year-all" value="All" onchange="toggleCheckboxes('year')"> üéì All</label><label class="checkbox-item"><input type="checkbox" class="year-chk" value="1st"> 1st (25)</label><label class="checkbox-item"><input type="checkbox" class="year-chk" value="2nd"> 2nd (24)</label><label class="checkbox-item"><input type="checkbox" class="year-chk" value="3rd"> 3rd (23)</label><label class="checkbox-item"><input type="checkbox" class="year-chk" value="4th"> 4th (22)</label></div></div>
                </div>
                <div style="margin-bottom: 15px; background: #fffbe6; padding: 10px; border: 1px solid #ffe58f; border-radius: 8px;"><label style="font-weight: bold; color: #d63031; cursor: pointer; display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="isPinned" style="width: auto; margin: 0;"> üìå Pin this Notice to Top</label></div>
                <div style="margin-bottom: 15px;"><label style="font-weight: 600; font-size: 0.9rem;">Event Title</label><input type="text" id="title" placeholder="e.g. Annual Tech Symposium" required></div>
                <div style="margin-bottom: 15px;"><label style="font-weight: 600; font-size: 0.9rem;">Category</label><select id="category" onchange="toggleOtherInput()"><option value="General">üì¢ General</option><option value="Placement">üíº Placement</option><option value="Hackathon">üíª Hackathon</option><option value="Club">ü§ù Club Event</option><option value="Event">üéâ Fest/Cult</option><option value="Exam">üìù Exam</option><option value="Others">‚ùì Others (Specify)</option></select><input type="text" id="otherCategoryInput" class="hidden" placeholder="Type category name" style="margin-top: 5px; border-left: 3px solid var(--primary);"></div>
                <div class="file-upload-box"><label style="cursor: pointer; display: block;"><i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; color: var(--primary);"></i><br><span style="font-size: 0.9rem;">Click to Upload Image or PDF (Max 500KB)</span><input type="file" id="imgInput" accept="image/png, image/jpeg, application/pdf" style="display: none;" onchange="handleFileUpload(this)"></label><img id="previewImg" class="file-preview"><div id="previewPdf" class="hidden" style="margin-top: 10px; color: #d63031; font-weight: bold;"><i class="fas fa-file-pdf" style="font-size: 2rem;"></i><br>PDF Selected</div></div>
                <input type="url" id="imgLink" placeholder="OR Paste Image URL (Optional)">
                <input type="url" id="regLink" placeholder="üîó Registration Link (Google Form, etc.)">
                <div style="margin-bottom: 15px;"><label style="font-weight: 600; font-size: 0.9rem; display:block; margin-bottom:5px;">Description</label><div id="editor-container"></div></div>
                
                <div style="display: flex; gap: 10px;"><div style="flex:1"><label style="font-size:0.8rem;">Start</label><input type="date" id="startDate" required></div><div style="flex:1"><label style="font-size:0.8rem;">End</label><input type="date" id="endDate" required></div></div>
                <div style="display: flex; gap: 10px; margin-top: 15px;"><button type="submit" id="submitBtn" class="btn btn-primary" style="flex: 1;">Publish & Send Emails üìß</button><button type="button" id="cancelEditBtn" class="btn btn-outline hidden" onclick="resetForm()">Cancel</button></div>
            </form>
        </div>

        <div class="controls-container">
            <div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Search events..." onkeyup="handleSearch()"></div>
            <div class="tab-group">
                <button class="tab-btn active" id="tab-active" onclick="switchTab('active')">üî• Active</button>
                <button class="tab-btn" id="tab-archive" onclick="switchTab('archive')">üìú History</button>
                <button class="tab-btn" id="tab-my" onclick="switchTab('my')">‚ú® My Events</button>
                <button class="tab-btn" id="tab-calendar" onclick="switchTab('calendar')">üìÖ Calendar</button>
            </div>
        </div>

        <div id="noticesContainer">Loading...</div>
        <div id="calendarView" class="hidden"></div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        console.log("Notifly Script Loaded");
        const validStudentDb = ['24B01A0591', '24B01A05C5', '24B01A05B5', '24B01A05C3', '24B01A05B6'].map(id => id.toUpperCase());
        const branchMap = { '05': 'CSE', '04': 'ECE', '03': 'MECH', '12': 'IT', '02': 'EEE', '01': 'CIVIL', '42': 'AIML', '44': 'AIDS' };
        
        // --- INIT QUILL ---
        var quill = new Quill('#editor-container', { theme: 'snow', placeholder: 'Write full description here (supports bold, links, lists)...' });

        // --- EMAILJS ---
        try { emailjs.init("xKh_OoZwvW09wngJQ"); } catch(e) { console.error("EmailJS Init Failed:", e); }
        const SERVICE_ID = "service_gk9pw29", TEMPLATE_ID = "template_ocnnpxi";
        
        // --- FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyDKku9r_inz1wrqfYVS1ykrZUHPRJMXoec", authDomain: "notifly-fbf34.firebaseapp.com", projectId: "notifly-fbf34", storageBucket: "notifly-fbf34.firebasestorage.app", messagingSenderId: "394537424596", appId: "1:394537424596:web:27277b2a3491074691cd41", measurementId: "G-E0C1LC8NEY" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null, allNotices = [], searchQuery = "", currentTab = "active", commentUnsubscribe = null, notifUnsubscribe = null, activeNoticeId = null, calendarInstance = null;

        function getDeptFromID(rollNo) { if(!rollNo || rollNo.length < 8) return 'General'; return branchMap[rollNo.substring(6, 8)] || 'General'; }
        function getYearFromID(rollNo) { if(!rollNo || rollNo.length < 2) return 'Alumni'; const prefix = rollNo.substring(0, 2); if(prefix === '25') return '1st'; if(prefix === '24') return '2nd'; if(prefix === '23') return '3rd'; if(prefix === '22') return '4th'; return 'Alumni'; }
        function generateCalendarUrl(title, desc, start, end) { if(!start || !end) return "#"; const clean = (d) => d.replace(/-/g, ''); const s = clean(start); const eDate = new Date(end); eDate.setDate(eDate.getDate() + 1); const e = clean(eDate.toISOString().split('T')[0]); const plainDesc = desc.replace(/<[^>]+>/g, ''); return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(plainDesc)}&dates=${s}/${e}`; }

        function openLogin(role) { document.getElementById('loginModal').classList.remove('hidden'); document.getElementById('loginModal').dataset.role = role; document.getElementById('userId').placeholder = role === 'admin' ? "e.g. HOD-CSE" : "e.g. 24B01A0591"; }
        function closeLogin() { document.getElementById('loginModal').classList.add('hidden'); }
        async function handleLogin(e) { e.preventDefault(); const id = document.getElementById('userId').value.trim().toUpperCase(); const pass = document.getElementById('password').value; const roleType = document.getElementById('loginModal').dataset.role; if (roleType === 'student' && !validStudentDb.includes(id)) { alert("üö´ ACCESS DENIED"); return; } const userRef = db.collection('users').doc(id); const doc = await userRef.get(); if (!doc.exists) { let defaultPass = roleType === 'admin' ? '123' : 'student'; if(id === 'PRINCIPAL') defaultPass = 'admin'; if (pass === defaultPass) { const newUser = { id: id, password: pass, role: roleType, dept: roleType === 'student' ? getDeptFromID(id) : (id.includes('HOD') ? id.split('-')[1] : 'CSE'), year: roleType === 'student' ? getYearFromID(id) : 'Staff', avatar: `https://ui-avatars.com/api/?name=${id}&background=6C5CE7&color=fff` }; await userRef.set(newUser); loginSuccess(newUser); } else { alert("Incorrect Default Password."); } } else { if (doc.data().password === pass) loginSuccess(doc.data()); else alert("Incorrect Password!"); } }
        function loginSuccess(user) { currentUser = user; if(currentUser.role === 'student' && !currentUser.year) currentUser.year = getYearFromID(currentUser.id); closeLogin(); document.getElementById('landingPage').classList.add('hidden'); document.getElementById('mainDashboard').style.display = 'block'; document.getElementById('welcomeMsg').innerText = `Hi, ${user.id}`; if (user.role === 'admin') { document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('dept-all').disabled = false; document.querySelectorAll('.dept-chk').forEach(b => { b.disabled = false; b.checked = false; }); } else { document.getElementById('adminPanel').classList.add('hidden'); } renderNotices(); subscribeNotifications(); }
        function logout() { location.reload(); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function toggleNotifications() { document.getElementById('notifDropdown').classList.toggle('show'); }
        function subscribeNotifications() { notifUnsubscribe = db.collection('notifications').orderBy('timestamp', 'desc').limit(20).onSnapshot(snapshot => { const list = document.getElementById('notifList'); const badge = document.getElementById('notifBadge'); let unreadCount = 0; let html = ''; snapshot.docs.forEach(doc => { const n = doc.data(); if(n.targetRole === currentUser.role) { const isRead = n.readBy && n.readBy.includes(currentUser.id); if(!isRead) unreadCount++; const time = n.timestamp ? new Date(n.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now'; html += `<div class="notif-item ${!isRead ? 'unread' : ''}" onclick="handleNotifClick('${doc.id}', '${n.eventId}')"><div class="notif-text">${n.message}</div><div class="notif-time">${time}</div></div>`; } }); list.innerHTML = html || '<div style="padding:15px; text-align:center; color:#999; font-size:0.8rem">No new notifications</div>'; badge.innerText = unreadCount; badge.classList.toggle('hidden', unreadCount === 0); }); }
        function handleNotifClick(notifId, eventId) { db.collection('notifications').doc(notifId).update({ readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.id) }); openEventDetails(eventId); document.getElementById('notifDropdown').classList.remove('show'); }
        function clearAllNotifications() { alert("All notifications marked as read!"); document.getElementById('notifDropdown').classList.remove('show'); }
        function handleSearch() { searchQuery = document.getElementById('searchInput').value.toLowerCase(); renderNotices(); }
        function switchTab(tab) { currentTab = tab; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tab}`).classList.add('active'); if(tab === 'calendar') { document.getElementById('noticesContainer').classList.add('hidden'); document.getElementById('calendarView').classList.remove('hidden'); renderCalendar(); } else { document.getElementById('noticesContainer').classList.remove('hidden'); document.getElementById('calendarView').classList.add('hidden'); renderNotices(); } }
        function renderCalendar() { var calendarEl = document.getElementById('calendarView'); const relevantNotices = allNotices.filter(n => { if (currentUser.role !== 'admin' && n.hidden) return false; const myDept = currentUser.dept; const myYear = currentUser.year; const depts = n.targetDepts || ['All']; const years = n.targetYears || ['All']; const isDeptMatch = depts.includes('All') || depts.includes(myDept); const isYearMatch = years.includes('All') || years.includes(myYear); return (currentUser.role === 'admin') || (isDeptMatch && isYearMatch); }); if(calendarInstance) calendarInstance.destroy(); calendarInstance = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' }, height: 'auto', events: relevantNotices.map(n => ({ title: n.title, start: n.startDate, end: new Date(new Date(n.endDate).getTime() + 86400000).toISOString().split('T')[0], id: n.id, backgroundColor: n.registered && n.registered.includes(currentUser.id) ? '#00b894' : '#6C5CE7', borderColor: 'transparent' })), eventClick: function(info) { openEventDetails(info.event.id); } }); calendarInstance.render(); }
        function openProfileModal() { document.getElementById('profileModal').classList.remove('hidden'); document.getElementById('profileId').value = currentUser.id; document.getElementById('profilePhone').value = currentUser.phone || ''; document.getElementById('profileAvatar').src = currentUser.avatar || `https://ui-avatars.com/api/?name=${currentUser.id}&background=6C5CE7&color=fff`; document.getElementById('profileBase64').value = ''; }
        function handleProfileImageUpload(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { document.getElementById('profileAvatar').src = e.target.result; document.getElementById('profileBase64').value = e.target.result; }; reader.readAsDataURL(file); }
        async function handleSaveProfile(e) { e.preventDefault(); const phone = document.getElementById('profilePhone').value.trim(); const avatar = document.getElementById('profileBase64').value || currentUser.avatar; try { await db.collection('users').doc(currentUser.id).update({ phone: phone, avatar: avatar }); currentUser.phone = phone; currentUser.avatar = avatar; alert("‚úÖ Profile Updated!"); document.getElementById('profileModal').classList.add('hidden'); } catch(err) { alert("Error: " + err.message); } }
        function openPasswordModal() { document.getElementById('passwordModal').classList.remove('hidden'); }
        async function handleChangePassword(e) { e.preventDefault(); const oldP = document.getElementById('oldPass').value; const newP = document.getElementById('newPass').value; if (oldP !== currentUser.password) { alert("‚ùå Old password incorrect!"); return; } try { await db.collection('users').doc(currentUser.id).update({ password: newP }); currentUser.password = newP; alert("‚úÖ Password updated!"); document.getElementById('passwordModal').classList.add('hidden'); } catch (error) { alert("Error updating password."); } }
        function handleFileUpload(input) { const file = input.files[0]; if (!file) return; if (file.size > 500 * 1024) { alert("‚ùå File is too big! Max 500KB."); input.value = ""; return; } const reader = new FileReader(); reader.onload = function(e) { const base64String = e.target.result; document.getElementById('uploadedBase64').value = base64String; if (file.type === "application/pdf") { document.getElementById('previewImg').style.display = 'none'; document.getElementById('previewPdf').classList.remove('hidden'); } else { document.getElementById('previewImg').src = base64String; document.getElementById('previewImg').style.display = 'block'; document.getElementById('previewPdf').classList.add('hidden'); } }; reader.readAsDataURL(file); }
        function openEventDetails(id) { const n = allNotices.find(item => item.id === id); if(!n) return; activeNoticeId = id; document.getElementById('detailTitle').innerText = n.title; document.getElementById('detailDesc').innerHTML = n.description; document.getElementById('detailDates').innerText = `${n.startDate} to ${n.endDate}`; const img = document.getElementById('detailImg'); const pdfSec = document.getElementById('detailPdfSection'); const pdfLink = document.getElementById('detailPdfLink'); if(n.base64Img && n.base64Img.startsWith("data:application/pdf")) { img.classList.add('hidden'); pdfSec.classList.remove('hidden'); pdfLink.href = n.base64Img; } else if(n.base64Img) { pdfSec.classList.add('hidden'); img.src = n.base64Img; img.classList.remove('hidden'); } else if(n.imgLink) { pdfSec.classList.add('hidden'); img.src = n.imgLink; img.classList.remove('hidden'); } else { img.classList.add('hidden'); pdfSec.classList.add('hidden'); } const tagContainer = document.getElementById('detailTags'); const depts = n.targetDepts || ['All']; const years = n.targetYears || ['All']; tagContainer.innerHTML = `${n.isPinned ? '<span class="pinned-badge">üìå Urgent</span><br>' : ''}<span class="dept-tag">${depts.join(', ')}</span><span class="year-tag">${years.join(', ')}</span>`; const calUrl = generateCalendarUrl(n.title, n.description, n.startDate, n.endDate); document.getElementById('addToCalBtn').onclick = () => window.open(calUrl, '_blank'); const extBtn = document.getElementById('detailRegLink'); if(n.regLink) { extBtn.href = n.regLink; extBtn.classList.remove('hidden'); } else { extBtn.classList.add('hidden'); } const intBtn = document.getElementById('internalRegBtn'); const adminExportBtn = document.getElementById('adminExportBtn'); if(currentUser.role === 'student') { adminExportBtn.classList.add('hidden'); intBtn.classList.remove('hidden'); const isReg = n.registered && n.registered.includes(currentUser.id); intBtn.innerText = isReg ? "‚úÖ Already Registered" : "Register Interest"; intBtn.onclick = () => toggleRegisterInterest(n.id); } else { intBtn.classList.add('hidden'); adminExportBtn.classList.remove('hidden'); } loadComments(id); document.getElementById('eventDetailModal').classList.remove('hidden'); }
        function closeDetailModal() { document.getElementById('eventDetailModal').classList.add('hidden'); if (commentUnsubscribe) { commentUnsubscribe(); commentUnsubscribe = null; } activeNoticeId = null; }
        function downloadParticipantsCSV() { const n = allNotices.find(item => item.id === activeNoticeId); if(!n || !n.registered || n.registered.length === 0) { alert("No students registered for this event yet."); return; } let csvContent = "data:text/csv;charset=utf-8,Student ID\n" + n.registered.join("\n"); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `${n.title}_participants.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        function loadComments(noticeId) { const list = document.getElementById('commentList'); list.innerHTML = 'Loading comments...'; commentUnsubscribe = db.collection('notices').doc(noticeId).collection('comments').orderBy('timestamp', 'asc').onSnapshot(snapshot => { if(snapshot.empty) { list.innerHTML = '<div style="text-align: center; color: #999; font-size: 0.9rem;">No queries yet.</div>'; return; } list.innerHTML = snapshot.docs.map(doc => { const c = doc.data(); const cid = doc.id; const isAdmin = c.role === 'admin'; const isOwner = c.userId === currentUser.id; const canDelete = isOwner || currentUser.role === 'admin'; const time = c.timestamp ? new Date(c.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now'; return `<div class="comment-card ${isAdmin ? 'admin-comment' : ''}" id="card-${cid}"><div class="comment-header"><span><strong>${c.userId}</strong>${isAdmin ? '<span class="badge-admin">STAFF</span>' : ''}</span><div style="display:flex; gap:5px; align-items:center;"><span style="font-size:0.7rem">${time}</span>${isOwner ? `<i class="fas fa-pen action-icon" onclick="openEditComment('${cid}', '${c.text.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')" title="Edit"></i>` : ''}${canDelete ? `<i class="fas fa-trash action-icon delete-icon" onclick="deleteComment('${noticeId}', '${cid}')" title="Delete"></i>` : ''}</div></div><div id="view-${cid}" class="comment-text">${c.text}</div><form id="edit-${cid}" class="hidden comment-edit-form" onsubmit="handleSaveEdit(event, '${noticeId}', '${cid}')"><input type="text" id="input-${cid}" value="${c.text.replace(/"/g, '&quot;')}"><button type="submit" class="btn btn-primary btn-xs">Save</button><button type="button" class="btn btn-outline btn-xs" onclick="cancelEditComment('${cid}')">Cancel</button></form></div>`; }).join(''); list.scrollTop = list.scrollHeight; }); }
        function handlePostComment(e) { e.preventDefault(); const input = document.getElementById('commentInput'); const text = input.value.trim(); if(!text || !activeNoticeId) return; db.collection('notices').doc(activeNoticeId).collection('comments').add({ text: text, userId: currentUser.id, role: currentUser.role, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { input.value = ""; const currentEvent = allNotices.find(n => n.id === activeNoticeId); const eventTitle = currentEvent ? currentEvent.title : 'an Event'; let targetRole = currentUser.role === 'admin' ? 'student' : 'admin'; let msg = currentUser.role === 'admin' ? `‚úÖ Staff replied to a query on "${eventTitle}"` : `‚ùì New Query from ${currentUser.id} on "${eventTitle}"`; db.collection('notifications').add({ eventId: activeNoticeId, message: msg, targetRole: targetRole, timestamp: firebase.firestore.FieldValue.serverTimestamp(), readBy: [] }); }).catch(err => alert("Error: " + err.message)); }
        function deleteComment(noticeId, commentId) { if(confirm("Delete?")) db.collection('notices').doc(noticeId).collection('comments').doc(commentId).delete(); }
        function openEditComment(cid, text) { document.getElementById(`view-${cid}`).classList.add('hidden'); document.getElementById(`edit-${cid}`).classList.remove('hidden'); document.getElementById(`input-${cid}`).value = text; }
        function cancelEditComment(cid) { document.getElementById(`view-${cid}`).classList.remove('hidden'); document.getElementById(`edit-${cid}`).classList.add('hidden'); }
        function handleSaveEdit(e, noticeId, cid) { e.preventDefault(); const newText = document.getElementById(`input-${cid}`).value.trim(); if(!newText) return; db.collection('notices').doc(noticeId).collection('comments').doc(cid).update({ text: newText }).then(() => cancelEditComment(cid)); }
        function toggleRegisterInterest(id) { const n = allNotices.find(item => item.id === id); const isReg = n.registered && n.registered.includes(currentUser.id); if(isReg) { db.collection("notices").doc(id).update({ registered: firebase.firestore.FieldValue.arrayRemove(currentUser.id) }); document.getElementById('internalRegBtn').innerText = "Register Interest"; } else { db.collection("notices").doc(id).update({ registered: firebase.firestore.FieldValue.arrayUnion(currentUser.id) }); document.getElementById('internalRegBtn').innerText = "‚úÖ Already Registered"; alert("Registered Successfully!"); } }
        function toggleOtherInput() { const val = document.getElementById('category').value; const input = document.getElementById('otherCategoryInput'); if(val === 'Others') { input.classList.remove('hidden'); input.required = true; } else { input.classList.add('hidden'); input.required = false; } }
        function toggleCheckboxes(type) { const allBox = document.getElementById(`${type}-all`); document.querySelectorAll(`.${type}-chk`).forEach(b => { b.checked = allBox.checked; b.disabled = allBox.checked; }); }
        function getSelectedItems(type) { if(document.getElementById(`${type}-all`).checked) return ['All']; const selected = []; document.querySelectorAll(`.${type}-chk:checked`).forEach(b => selected.push(b.value)); return selected.length > 0 ? selected : ['All']; }
        function setItemsInForm(type, items) { const allBox = document.getElementById(`${type}-all`); allBox.disabled = false; document.querySelectorAll(`.${type}-chk`).forEach(b => b.disabled = false); if(items.includes('All')) { allBox.checked = true; toggleCheckboxes(type); } else { allBox.checked = false; toggleCheckboxes(type); document.querySelectorAll(`.${type}-chk`).forEach(b => { if(items.includes(b.value)) b.checked = true; }); } }
        function sendRealEmails(targetDepts, targetYears, title, category, description, start, end) { let targets = validStudentDb; if(!targetDepts.includes('All')) targets = targets.filter(id => targetDepts.includes(getDeptFromID(id))); if(!targetYears.includes('All')) targets = targets.filter(id => targetYears.includes(getYearFromID(id))); if(targets.length === 0) return; alert(`‚úÖ Published! \nüìß Emailing ${targets.length} students...`); const plainDesc = description.replace(/<[^>]+>/g, ''); const calendarLink = generateCalendarUrl(title, plainDesc, start, end); targets.forEach(studentID => { emailjs.send(SERVICE_ID, TEMPLATE_ID, { to_email: `${studentID}@svecw.edu.in`, title: title, category: category, message: plainDesc, calendar_link: calendarLink }); }); }
        
        const noticeForm = document.getElementById('noticeForm');
        if (noticeForm) {
            noticeForm.addEventListener('submit', (e) => {
                e.preventDefault(); const btn = document.getElementById('submitBtn'); const originalText = btn.innerText; btn.innerText = "‚è≥ Publishing..."; btn.disabled = true;
                let finalCategory = document.getElementById('category').value; if (finalCategory === 'Others') finalCategory = document.getElementById('otherCategoryInput').value.trim();
                const data = { title: document.getElementById('title').value, targetDepts: getSelectedItems('dept'), targetYears: getSelectedItems('year'), category: finalCategory, description: quill.root.innerHTML, startDate: document.getElementById('startDate').value, endDate: document.getElementById('endDate').value, regLink: document.getElementById('regLink').value, imgLink: document.getElementById('imgLink').value, base64Img: document.getElementById('uploadedBase64').value, isPinned: document.getElementById('isPinned').checked, timestamp: firebase.firestore.FieldValue.serverTimestamp(), hidden: false };
                const editId = document.getElementById('editId').value;
                let dbPromise = editId ? db.collection("notices").doc(editId).update({ ...data, timestamp: undefined, hidden: undefined }) : db.collection("notices").add(data);
                dbPromise.then(() => { if (!editId) { try { sendRealEmails(data.targetDepts, data.targetYears, data.title, data.category, data.description, data.startDate, data.endDate); } catch (emailErr) {} } alert(editId ? "‚úÖ Updated!" : "‚úÖ Published!"); resetForm(); }).catch((error) => alert("Error: " + error.message)).finally(() => { btn.innerText = originalText; btn.disabled = false; });
            });
        }
        function toggleHide(id, status) { db.collection("notices").doc(id).update({ hidden: !status }); }
        function deleteNotice(id) { if(confirm("Delete?")) db.collection("notices").doc(id).delete(); }
        function editNotice(id) { const n = allNotices.find(d => d.id === id); document.getElementById('editId').value = n.id; document.getElementById('title').value = n.title; quill.root.innerHTML = n.description; document.getElementById('startDate').value = n.startDate; document.getElementById('endDate').value = n.endDate; document.getElementById('regLink').value = n.regLink; document.getElementById('imgLink').value = n.imgLink; document.getElementById('isPinned').checked = n.isPinned || false; if(n.base64Img) document.getElementById('uploadedBase64').value = n.base64Img; setItemsInForm('dept', n.targetDepts || []); setItemsInForm('year', n.targetYears || []); document.getElementById('submitBtn').innerText = "Update"; document.getElementById('cancelEditBtn').classList.remove('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function resetForm() { document.getElementById('noticeForm').reset(); quill.setContents([]); document.getElementById('editId').value = ""; document.getElementById('uploadedBase64').value = ""; document.getElementById('previewImg').style.display = "none"; document.getElementById('previewPdf').classList.add('hidden'); document.getElementById('submitBtn').innerText = "Publish & Send Emails üìß"; document.getElementById('submitBtn').disabled = false; document.getElementById('cancelEditBtn').classList.add('hidden'); setItemsInForm('dept', ['All']); setItemsInForm('year', ['All']); }
        db.collection("notices").orderBy("timestamp", "desc").onSnapshot((snap) => { allNotices = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderNotices(); });
        function renderNotices() { if(!currentUser) return; const container = document.getElementById('noticesContainer'); const today = new Date().toISOString().split('T')[0]; const filtered = allNotices.filter(n => { if (currentUser.role !== 'admin' && n.hidden) return false; const myDept = currentUser.dept; const myYear = currentUser.year; const depts = n.targetDepts || ['All']; const years = n.targetYears || ['All']; const isDeptMatch = depts.includes('All') || depts.includes(myDept); const isYearMatch = years.includes('All') || years.includes(myYear); if (currentUser.role === 'student' && (!isDeptMatch || !isYearMatch)) return false; const title = n.title || ""; const desc = (n.description || "").replace(/<[^>]+>/g, ''); const cat = n.category || ""; const matchesSearch = title.toLowerCase().includes(searchQuery) || desc.toLowerCase().includes(searchQuery) || cat.toLowerCase().includes(searchQuery); if(!matchesSearch) return false; const end = n.endDate || today; if (currentTab === 'my') return n.registered && n.registered.includes(currentUser.id); else if (currentTab === 'active') return end >= today; else return end < today; }); filtered.sort((a, b) => { if (a.isPinned === b.isPinned) return 0; return a.isPinned ? -1 : 1; }); container.innerHTML = filtered.map(n => { const isHidden = n.hidden === true; const isPinned = n.isPinned === true; const count = n.registered ? n.registered.length : 0; let catColor = '#6C5CE7'; const c = n.category ? n.category.toLowerCase() : 'general'; if(c.includes('exam')) catColor = '#d63031'; else if(c.includes('placement')) catColor = '#0984e3'; else if(c.includes('hackathon')) catColor = '#2d3436'; else if(c.includes('club')) catColor = '#00cec9'; else if(c.includes('fest') || c.includes('event')) catColor = '#e17055'; const depts = n.targetDepts || []; const plainDesc = (n.description || "").replace(/<[^>]+>/g, ''); return `<div class="notice-card ${isHidden ? 'hidden-event' : ''}"><div style="display:flex; justify-content:space-between; align-items: flex-start;"><div style="width: 100%;">${isHidden ? '<span style="background:red; color:white; padding:2px 5px; font-size:0.7rem;">HIDDEN</span>' : ''}<div class="tag-container">${isPinned ? '<span class="pinned-badge">üìå Urgent</span>' : ''}<span class="category-tag" style="background: ${catColor}15; color: ${catColor}; border: 1px solid ${catColor}30;">${n.category || 'General'}</span><span class="dept-tag">${depts.join(', ')}</span></div><h3 class="event-title-link" onclick="openEventDetails('${n.id}')">${n.title}</h3></div>${currentUser.role === 'admin' ? `<span class="registered-count">üë• ${count} Reg</span>` : ''}</div><p style="color:#555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;">${plainDesc}</p><div class="date-badge"><i class="far fa-calendar-alt"></i> <span>${n.startDate}</span> <i class="fas fa-arrow-right" style="font-size:0.7rem"></i> <span>${n.endDate}</span></div>${currentUser.role === 'admin' ? `<div class="admin-actions" style="margin-top:10px;"><button onclick="toggleHide('${n.id}', ${isHidden})" class="btn btn-outline" style="font-size:0.8rem;">${isHidden ? 'Unhide' : 'Hide'}</button><button onclick="editNotice('${n.id}')" class="btn btn-primary" style="font-size:0.8rem;">Edit</button><button onclick="deleteNotice('${n.id}')" class="btn btn-danger" style="font-size:0.8rem;">Delete</button></div>` : ''}</div>`; }).join(''); if(filtered.length===0) container.innerHTML=`<div style='text-align:center; padding: 20px; color:#999'>No notices found.</div>`; }
    </script>
</body>
</html>